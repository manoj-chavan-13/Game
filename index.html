<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Pulse Synthesizer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            color: #ccc;
        }

        /* Pro Audio UI Styles */
        .pro-panel {
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .pro-text {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -0.05em;
        }

        .accent-text {
            color: #00bcd4;
            text-shadow: 0 0 1px rgba(0, 188, 212, 0.5);
        }

        /* Buttons */
        .pro-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #666;
            transition: all 0.1s ease;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            text-transform: uppercase;
        }

        .pro-btn:hover {
            border-color: #555;
            color: #aaa;
        }

        .pro-btn.active {
            background: #00bcd4;
            color: #000;
            border-color: #00bcd4;
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.3);
            font-weight: bold;
        }

        .pro-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 2px;
            background: #333;
            outline: none;
        }

        .pro-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: #00bcd4;
            border-radius: 2px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.4);
        }

        /* Piano Keys */
        .key {
            transition: background 0.05s, transform 0.05s;
            cursor: pointer;
            position: relative;
            z-index: 10;
        }

        .white-key {
            background: #e5e5e5;
            border-radius: 0 0 3px 3px;
            box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.1), 0 2px 2px rgba(0, 0, 0, 0.3);
            border: 1px solid #000;
            border-top: none;
        }

        .white-key.active {
            background: #00bcd4;
            border-color: #008ba3;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3);
            transform: translateY(2px);
        }

        .black-key {
            background: linear-gradient(180deg, #222 0%, #111 100%);
            border-radius: 0 0 2px 2px;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.1), 2px 2px 2px rgba(0, 0, 0, 0.4);
            z-index: 20;
            border: 1px solid #000;
            border-top: none;
        }

        .black-key.active {
            background: #00bcd4;
            background: linear-gradient(180deg, #00acc1 0%, #008ba3 100%);
            transform: translateY(2px);
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
        }

        .key-label {
            pointer-events: none;
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-family: 'JetBrains Mono', monospace;
            color: rgba(0, 0, 0, 0.4);
            font-weight: 700;
        }

        .black-key .key-label {
            color: rgba(255, 255, 255, 0.4);
        }

        /* Visualizer */
        #visualizer {
            width: 100%;
            height: 100%;
            display: block;
        }

        .grid-bg {
            background-size: 40px 40px;
            background-image:
                linear-gradient(to right, #ffffff05 1px, transparent 1px),
                linear-gradient(to bottom, #ffffff05 1px, transparent 1px);
        }
    </style>
</head>

<body class="h-screen flex flex-col items-center p-4 lg:p-6 grid-bg">

    <!-- Top Rack: Header & Oscilloscope -->
    <div class="w-full max-w-6xl flex flex-col md:flex-row gap-4 mb-4 h-32 md:h-40">

        <!-- Brand / Status -->
        <div class="pro-panel w-full md:w-1/4 p-4 flex flex-col justify-between relative overflow-hidden">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-2 h-2 rounded-sm bg-[#00bcd4] shadow-[0_0_5px_#00bcd4]"></div>
                    <h1 class="pro-text text-xl font-bold text-white tracking-tight">NEON<span
                            class="font-light text-gray-500">SYNTH</span></h1>
                </div>
                <p class="text-[9px] text-gray-500 font-mono tracking-widest uppercase">Pro Audio Engine v2.1</p>
            </div>

            <div class="flex justify-between items-end border-t border-[#222] pt-2">
                <div class="text-[9px] text-gray-600 font-mono">
                    BUFFER: 256<br>SR: 48kHz
                </div>
                <div class="text-right">
                    <div class="text-[9px] text-[#00bcd4] font-mono" id="status-text">READY</div>
                    <div class="text-[9px] text-gray-500 font-mono">INST: <span id="inst-display"
                            class="text-white">PIANO</span></div>
                </div>
            </div>
            <div class="absolute top-0 right-0 w-1 h-full bg-[#00bcd4] opacity-20"></div>
        </div>

        <!-- Visualizer Screen -->
        <div class="pro-panel flex-grow relative bg-black flex items-center justify-center group">
            <canvas id="visualizer"></canvas>
            <div class="absolute inset-0 pointer-events-none border border-[#ffffff05]"></div>

            <div id="start-overlay"
                class="absolute inset-0 flex items-center justify-center bg-black/80 z-20 transition-opacity duration-300">
                <button id="start-btn"
                    class="pro-text text-[#00bcd4] border border-[#00bcd4] px-6 py-2 rounded text-xs tracking-widest hover:bg-[#00bcd4] hover:text-black transition-colors uppercase font-bold">
                    Initialize Audio
                </button>
            </div>
        </div>

    </div>

    <!-- Middle Rack: Controls -->
    <div class="w-full max-w-6xl pro-panel p-4 mb-4 grid grid-cols-1 md:grid-cols-12 gap-6 items-center">

        <!-- Instrument Selector -->
        <div class="md:col-span-5 flex flex-col">
            <label class="text-[9px] text-gray-500 font-mono uppercase tracking-widest mb-2">Instrument Bank</label>
            <div class="grid grid-cols-4 gap-1">
                <button class="pro-btn py-3 rounded-sm active" data-inst="piano">Piano</button>
                <button class="pro-btn py-3 rounded-sm" data-inst="guitar">Guitar</button>
                <button class="pro-btn py-3 rounded-sm" data-inst="bansuri">Bansuri</button>
                <button class="pro-btn py-3 rounded-sm" data-inst="synth">Synth</button>
            </div>
        </div>

        <!-- Synth Specific Controls (Only visible in synth mode mostly, but kept for all for simplicity) -->
        <div class="md:col-span-3 flex flex-col items-center border-l border-r border-[#222] px-4">
            <label class="text-[9px] text-gray-500 font-mono uppercase tracking-widest mb-2">Waveform (Synth)</label>
            <div class="grid grid-cols-2 gap-1 w-full">
                <button class="pro-btn py-1 rounded-sm active wave-btn" data-wave="sine">Sine</button>
                <button class="pro-btn py-1 rounded-sm wave-btn" data-wave="triangle">Tri</button>
                <button class="pro-btn py-1 rounded-sm wave-btn" data-wave="sawtooth">Saw</button>
                <button class="pro-btn py-1 rounded-sm wave-btn" data-wave="square">Sqr</button>
            </div>
        </div>

        <!-- Master Volume -->
        <div class="md:col-span-4 flex flex-col">
            <div class="flex justify-between mb-2">
                <label class="text-[9px] text-gray-500 font-mono uppercase tracking-widest">Master Output</label>
                <span id="vol-display" class="text-[9px] text-[#00bcd4] font-mono">75%</span>
            </div>
            <div class="relative h-6 flex items-center">
                <input type="range" id="volume-slider" min="0" max="100" value="75" class="pro-slider">
            </div>
        </div>
    </div>

    <!-- Bottom Rack: Keyboard -->
    <div class="w-full max-w-6xl flex-grow flex flex-col">
        <div
            class="relative w-full h-full min-h-[180px] bg-[#1a1a1a] rounded-t-md border-t-4 border-[#333] shadow-2xl flex justify-center pt-1 pb-2 px-1">
            <div id="piano-container" class="relative flex h-full w-full">
                <!-- Keys Generated Here -->
            </div>
        </div>
        <div class="w-full text-center py-2 text-[9px] text-gray-600 font-mono">
            KEYBOARD: [Z-M] Lower Octave â€¢ [Q-P] Upper Octave
        </div>
    </div>

    <script>
        // --- Audio Engine ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let masterGainNode;
        let analyser;

        let currentInstrument = 'piano';
        let synthWaveType = 'sine';
        const activeOscillators = {}; // Stores { osc, gain, filter, lfo }

        const noteFrequencies = {
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46
        };

        const pianoLayout = [
            { note: 'C3', type: 'white', keyBind: 'z' }, { note: 'C#3', type: 'black', keyBind: 's' },
            { note: 'D3', type: 'white', keyBind: 'x' }, { note: 'D#3', type: 'black', keyBind: 'd' },
            { note: 'E3', type: 'white', keyBind: 'c' }, { note: 'F3', type: 'white', keyBind: 'v' },
            { note: 'F#3', type: 'black', keyBind: 'g' }, { note: 'G3', type: 'white', keyBind: 'b' },
            { note: 'G#3', type: 'black', keyBind: 'h' }, { note: 'A3', type: 'white', keyBind: 'n' },
            { note: 'A#3', type: 'black', keyBind: 'j' }, { note: 'B3', type: 'white', keyBind: 'm' },

            { note: 'C4', type: 'white', keyBind: 'q' }, { note: 'C#4', type: 'black', keyBind: '2' },
            { note: 'D4', type: 'white', keyBind: 'w' }, { note: 'D#4', type: 'black', keyBind: '3' },
            { note: 'E4', type: 'white', keyBind: 'e' }, { note: 'F4', type: 'white', keyBind: 'r' },
            { note: 'F#4', type: 'black', keyBind: '5' }, { note: 'G4', type: 'white', keyBind: 't' },
            { note: 'G#4', type: 'black', keyBind: '6' }, { note: 'A4', type: 'white', keyBind: 'y' },
            { note: 'A#4', type: 'black', keyBind: '7' }, { note: 'B4', type: 'white', keyBind: 'u' },
            { note: 'C5', type: 'white', keyBind: 'i' }, { note: 'C#5', type: 'black', keyBind: '9' },
            { note: 'D5', type: 'white', keyBind: 'o' }, { note: 'D#5', type: 'black', keyBind: '0' },
            { note: 'E5', type: 'white', keyBind: 'p' }, { note: 'F5', type: 'white', keyBind: '[' }
        ];

        // --- Init ---
        const startBtn = document.getElementById('start-btn');
        const startOverlay = document.getElementById('start-overlay');
        const statusText = document.getElementById('status-text');
        const instDisplay = document.getElementById('inst-display');

        startBtn.addEventListener('click', initAudio);

        function initAudio() {
            if (!audioCtx) {
                try {
                    audioCtx = new AudioContext();
                    masterGainNode = audioCtx.createGain();
                    analyser = audioCtx.createAnalyser();

                    masterGainNode.gain.value = 0.5;
                    analyser.fftSize = 2048;

                    masterGainNode.connect(analyser);
                    analyser.connect(audioCtx.destination);

                    startOverlay.style.opacity = '0';
                    setTimeout(() => startOverlay.style.display = 'none', 300);
                    statusText.innerText = "ACTIVE";
                    statusText.classList.add('text-[#00bcd4]');
                    drawVisualizer();
                } catch (e) { console.error(e); }
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- Instruments Logic ---

        function playNote(note) {
            if (!audioCtx) initAudio();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

            if (activeOscillators[note]) return;

            const freq = noteFrequencies[note];
            const now = audioCtx.currentTime;
            const nodes = {};

            if (currentInstrument === 'piano') {
                // Piano: Triangle wave with envelope
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = 'triangle';
                osc.frequency.setValueAtTime(freq, now);

                osc.connect(gain);
                gain.connect(masterGainNode);

                // Sharp attack, steady decay
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.7, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 1.5); // Ring out

                osc.start(now);
                nodes.osc = osc;
                nodes.gain = gain;

            } else if (currentInstrument === 'guitar') {
                // Guitar: Sawtooth + LowPass Filter Pluck
                const osc = audioCtx.createOscillator();
                const filter = audioCtx.createBiquadFilter();
                const gain = audioCtx.createGain();

                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, now);

                filter.type = 'lowpass';
                filter.Q.value = 5; // Resonance for string tone
                // Filter Envelope (The Pluck)
                filter.frequency.setValueAtTime(200, now);
                filter.frequency.exponentialRampToValueAtTime(3000, now + 0.05); // Snap open
                filter.frequency.exponentialRampToValueAtTime(500, now + 0.4); // Close down

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(masterGainNode);

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.8, now + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 2.0);

                osc.start(now);
                nodes.osc = osc;
                nodes.gain = gain;
                nodes.filter = filter;

            } else if (currentInstrument === 'bansuri') {
                // Bansuri: Sine + Vibrato (LFO)
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const lfo = audioCtx.createOscillator();
                const lfoGain = audioCtx.createGain();

                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, now);

                // LFO logic (Vibrato)
                lfo.frequency.value = 5; // 5Hz wobble
                lfoGain.gain.value = 5; // Depth of wobble
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);

                osc.connect(gain);
                gain.connect(masterGainNode);

                // Soft breathy attack
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.6, now + 0.2); // Swells in
                gain.gain.setValueAtTime(0.6, now + 0.3);

                osc.start(now);
                lfo.start(now);

                nodes.osc = osc;
                nodes.gain = gain;
                nodes.lfo = lfo;

            } else {
                // Synth (Standard)
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = synthWaveType;
                osc.frequency.setValueAtTime(freq, now);

                osc.connect(gain);
                gain.connect(masterGainNode);

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.5, now + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.3, now + 0.1);

                osc.start(now);
                nodes.osc = osc;
                nodes.gain = gain;
            }

            activeOscillators[note] = nodes;
            highlightKey(note, true);
        }

        function stopNote(note) {
            if (!activeOscillators[note]) return;

            const nodes = activeOscillators[note];
            const now = audioCtx.currentTime;

            // Release envelope depends on instrument
            let release = 0.1;
            if (currentInstrument === 'bansuri') release = 0.4; // Flute fades out slowly
            if (currentInstrument === 'guitar') release = 0.3;
            if (currentInstrument === 'piano') release = 0.2;

            // Cancel any future decay ramps and set release
            nodes.gain.gain.cancelScheduledValues(now);
            nodes.gain.gain.setValueAtTime(nodes.gain.gain.value, now);
            nodes.gain.gain.exponentialRampToValueAtTime(0.001, now + release);

            if (nodes.osc) nodes.osc.stop(now + release + 0.1);
            if (nodes.lfo) nodes.lfo.stop(now + release + 0.1);

            // Cleanup memory
            setTimeout(() => {
                if (nodes.osc) nodes.osc.disconnect();
                if (nodes.gain) nodes.gain.disconnect();
                if (nodes.filter) nodes.filter.disconnect();
                if (nodes.lfo) nodes.lfo.disconnect();
            }, release * 1000 + 200);

            delete activeOscillators[note];
            highlightKey(note, false);
        }

        // --- Inputs & Controls ---

        // Instrument Switching
        document.querySelectorAll('[data-inst]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-inst]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentInstrument = btn.dataset.inst;
                instDisplay.innerText = currentInstrument.toUpperCase();

                // Toggle visibility of Synth controls
                const waveControls = document.querySelectorAll('.wave-btn');
                waveControls.forEach(wb => {
                    wb.style.opacity = currentInstrument === 'synth' ? '1' : '0.3';
                    wb.style.pointerEvents = currentInstrument === 'synth' ? 'auto' : 'none';
                });
            });
        });

        // Default visuals
        const waveControls = document.querySelectorAll('.wave-btn');
        waveControls.forEach(wb => {
            wb.style.opacity = '0.3';
            wb.style.pointerEvents = 'none';
        });


        // Waveform Switching (Synth Mode)
        document.querySelectorAll('[data-wave]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-wave]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                synthWaveType = btn.dataset.wave;
                // Auto switch to synth mode if wave clicked
                document.querySelector('[data-inst="synth"]').click();
            });
        });

        // Piano Generation
        const pianoContainer = document.getElementById('piano-container');
        const keyMapDOM = {};

        function renderPiano() {
            const whiteKeys = pianoLayout.filter(k => k.type === 'white');
            const totalWhite = whiteKeys.length;
            const whiteWidth = 100 / totalWhite;
            let whiteIndex = 0;

            pianoLayout.forEach(k => {
                const key = document.createElement('div');
                key.className = k.type === 'white' ? 'key white-key h-full' : 'key black-key h-[60%] absolute top-0';

                if (k.type === 'white') {
                    key.style.width = `${whiteWidth}%`;
                    whiteIndex++;
                } else {
                    key.style.width = `${whiteWidth * 0.7}%`;
                    const leftPos = (whiteIndex * whiteWidth) - ((whiteWidth * 0.7) / 2);
                    key.style.left = `${leftPos}%`;
                }

                const label = document.createElement('span');
                label.className = 'key-label';
                label.innerText = k.keyBind.toUpperCase();
                key.appendChild(label);

                const start = (e) => { e.preventDefault(); playNote(k.note); };
                const end = (e) => { e.preventDefault(); stopNote(k.note); };

                key.addEventListener('mousedown', start);
                key.addEventListener('mouseup', end);
                key.addEventListener('mouseleave', end);
                key.addEventListener('touchstart', start, { passive: false });
                key.addEventListener('touchend', end);

                keyMapDOM[k.note] = key;
                pianoContainer.appendChild(key);
            });
        }
        renderPiano();

        function highlightKey(note, on) {
            if (keyMapDOM[note]) {
                if (on) keyMapDOM[note].classList.add('active');
                else keyMapDOM[note].classList.remove('active');
            }
        }

        const keyMap = {};
        pianoLayout.forEach(k => keyMap[k.keyBind] = k.note);

        document.addEventListener('keydown', e => {
            if (e.repeat || e.ctrlKey || e.metaKey) return;
            const k = e.key.toLowerCase();
            if (keyMap[k]) playNote(keyMap[k]);
        });
        document.addEventListener('keyup', e => {
            const k = e.key.toLowerCase();
            if (keyMap[k]) stopNote(keyMap[k]);
        });

        const volSlider = document.getElementById('volume-slider');
        const volDisplay = document.getElementById('vol-display');
        volSlider.addEventListener('input', e => {
            const val = e.target.value;
            volDisplay.innerText = `${val}%`;
            if (masterGainNode) masterGainNode.gain.setValueAtTime(val / 100, audioCtx.currentTime);
        });

        // Visualizer
        const cvs = document.getElementById('visualizer');
        const ctx = cvs.getContext('2d');
        function resize() {
            cvs.width = cvs.offsetWidth;
            cvs.height = cvs.offsetHeight;
        }
        window.addEventListener('resize', resize);
        setTimeout(resize, 100);

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            if (!analyser) return;

            const buffer = analyser.frequencyBinCount;
            const data = new Uint8Array(buffer);
            analyser.getByteTimeDomainData(data);

            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, cvs.width, cvs.height);
            ctx.beginPath();
            ctx.strokeStyle = '#111';
            ctx.moveTo(0, cvs.height / 2);
            ctx.lineTo(cvs.width, cvs.height / 2);
            ctx.stroke();

            ctx.lineWidth = 1.5;
            ctx.strokeStyle = '#00bcd4';
            ctx.beginPath();
            const slice = cvs.width * 1.0 / buffer;
            let x = 0;
            for (let i = 0; i < buffer; i++) {
                const v = data[i] / 128.0;
                const y = v * cvs.height / 2;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                x += slice;
            }
            ctx.stroke();
        }
    </script>
</body>

</html>